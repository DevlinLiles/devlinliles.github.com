---
layout: post
title: How to constrain mocks for use with Complex Types
date: 2012-01-19
---
<p>Here are some tests to illustrate how to leverage RhinoMocks constraints. Notice that it is easier to get a passing test on failing code with a stub. The Strict mock will enforce the expectations at the time of the call, where the stub will only throw an exception on an AssertWasCalled. Due to this I would recommend that you explicitly do your setup and use strict mocks, or make sure to have the discipline to test those assertions. </p>  <p>&#160;</p>  <p>With the method Matches() ,you can use any predicate or method call that returns a boolean. You cannot however use a lambda with a method body aka () =&gt;{}. This will not compile.</p>  <p>[TestClass]</p>  <p>public class Tests</p>  <p>{</p>  <p>[TestMethod]   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; public void Should_Allow_Constraint()    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //Arrange    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var mock = MockRepository.GenerateStrictMock&lt;ITestExerciser&gt;();    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mock.Expect(x =&gt; x.DoSomething(Arg&lt;List&lt;ITest&gt;&gt;.Matches(c =&gt; c.First() is Test))).Return(&quot;TestPass&quot;);    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var tester = new Tester(mock);    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //Act    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var result = tester.DoIt();</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //Assert   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mock.VerifyAllExpectations();    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Assert.AreEqual(&quot;TestPass&quot;,result);    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; [TestMethod]   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; public void Should_Enforce_Constraint_On_Strict_Mock()    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //Arrange    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var mock = MockRepository.GenerateStrictMock&lt;ITestExerciser&gt;();    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mock.Expect(x =&gt; x.DoSomething(Arg&lt;List&lt;ITest&gt;&gt;.Matches(c =&gt; c.Any(t=&gt; t is Test)))).Return(&quot;TestPass&quot;);    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var tester = new Tester(mock);    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //Act    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var result = tester.DoItWrong();</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //Assert   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mock.VerifyAllExpectations();    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Assert.AreEqual(&quot;TestPass&quot;, result);    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; [TestMethod]   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; public void Should_Allow_Manual_Enforce_Constraint_On_Stub()    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //Arrange    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var mock = MockRepository.GenerateStub&lt;ITestExerciser&gt;();    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mock.Expect(x =&gt; x.DoSomething(Arg&lt;List&lt;ITest&gt;&gt;.Matches(c =&gt; TestSomething(c)))).Return(&quot;TestPass&quot;);    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var tester = new Tester(mock);    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //Act    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; var result = tester.DoItWrong();</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; //Assert   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mock.AssertWasCalled(x =&gt; x.DoSomething(Arg&lt;List&lt;ITest&gt;&gt;.Matches(c =&gt; c.Any(t =&gt; t is Test))));    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Assert.AreEqual(&quot;TestPass&quot;, result);    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; private bool TestSomething(List&lt;ITest&gt; tests)   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return true;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    <br />&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160; public class Tester   <br />&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; private ITestExerciser _testExerciser;</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; public Tester(ITestExerciser testExerciser)   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _testExerciser = testExerciser;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; public object DoIt()   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return _testExerciser.DoSomething(new List&lt;ITest&gt;() {new Test()});    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; public object DoItWrong()   <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return _testExerciser.DoSomething(new List&lt;ITest&gt;() { new TestBase() });    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    <br />&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160; public class TestExerciser : ITestExerciser   <br />&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; public object DoSomething(List&lt;ITest&gt; args)    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return null;    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }    <br />&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160; public interface ITestExerciser   <br />&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; object DoSomething(List&lt;ITest&gt; args);    <br />&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160; public class Test : TestBase   <br />&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160; public class TestBase : ITest   <br />&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; public int Id { get; set; }    <br />&#160;&#160;&#160; }</p>  <p>&#160;&#160;&#160; public interface ITest   <br />&#160;&#160;&#160; {    <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; int Id { get; set; }    <br />&#160;&#160;&#160; }</p>
